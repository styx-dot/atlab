#!/bin/bash

# NO set -e globally

# Always restore cursor
trap 'tput cnorm' EXIT

clear_line() { printf "\r\033[K"; }

spinner() {
    local pid="$1"
    local msg="$2"
    local spin='⠋⠙⠹⠸⠼⠴⠦⠧⠇⠏'
    local i=0

    tput civis

    while kill -0 "$pid" 2>/dev/null; do
        printf "\r%s... %s" "$msg" "${spin:i++%${#spin}:1}"
        sleep 0.12
    done

    wait "$pid"
    local status=$?

    clear_line

    if [[ $status -eq 0 ]]; then
        printf "\r\033[32m✔\033[0m %s done.\n" "$msg"
    else
        printf "\r\033[31m✘\033[0m %s FAILED (exit code %s)\n" "$msg" "$status"
    fi

    return $status
}

run() {
    local label="$1"
    shift

    (
        set -euo pipefail
        "$@"
    ) >/dev/null 2>&1 &

    local pid=$!
    spinner "$pid" "$label"
    local status=$?
    [[ $status -ne 0 ]] && exit $status
}

echo ""
echo "▶ 03-core-services.sh"
echo "────────────────────────────────────────────"
echo ""


run "[X] Installing ATLAB Root CA into server trust store" \
bash -c '
    cp ./certs/atlab-rootCA.crt /usr/local/share/ca-certificates/atlab-rootCA.crt
    chmod 644 /usr/local/share/ca-certificates/atlab-rootCA.crt
    update-ca-certificates
'


########################################
# 1. Install Registry + UI
########################################
run "[1/12] Creating registry namespace" \
    bash -c "kubectl create ns registry 2>/dev/null || true"

run "[2/12] Applying registry cert" \
    bash -c "kubectl apply -f ./registry/registry-cert.yaml"

run "[3/12] Installing Docker registry" \
    bash -c "helm install registry twuni/docker-registry -n registry -f ./registry/registry-value.yaml"

run "[4/12] Installing Registry UI" \
    bash -c "helm install registry-ui joxit/docker-registry-ui -n registry -f ./registry/registry-gui.yaml"


########################################
# 2. Build and Push Images
########################################
run "[5/12] Building Bitbucket image" \
    bash -c "podman build -t registry.at-lab.lab/bitbucket/bitbucket:v1.0.0 -f ./dockerfiles/bitbucket/Dockerfile ."

run "[6/12] Building Jenkins controller image" \
    bash -c 'podman build -t registry.at-lab.lab/jenkins/controller:v2.0.1 -f ./dockerfiles/jenkins/controller/Dockerfile.plugins .'

run "[7/12] Building Jenkins agent image" \
    bash -c 'podman build -t registry.at-lab.lab/jenkins/jenkins-agent:v1.0.1 -f ./dockerfiles/jenkins/jenkins-agent/Dockerfile .'

run "[8/12] Building Terraform image" \
    bash -c 'podman build -t registry.at-lab.lab/terraform/terraform:v1.0.1 -f ./dockerfiles/terraform/Dockerfile .'


run "[9/12] Pushing all images to registry" \
    bash -c '
        podman push registry.at-lab.lab/bitbucket/bitbucket:v1.0.0
        podman push registry.at-lab.lab/jenkins/controller:v2.0.1
        podman push registry.at-lab.lab/jenkins/jenkins-agent:v1.0.1
        podman push registry.at-lab.lab/terraform/terraform:v1.0.1
    '


########################################
# 3. Install Bitbucket
########################################
run "[10/12] Installing Bitbucket" \
    bash -c '
        kubectl create ns bitbucket 2>/dev/null || true
        kubectl apply -f ./bitbucket/bitbucket-cert.yaml
        helm install bitbucket-postgresql bitnami/postgresql -n bitbucket
   '


########################################
# 4. Install Jenkins
########################################
run "[11/12] Installing Jenkins" \
    bash -c '
        kubectl create ns jenkins 2>/dev/null || true
        kubectl apply -f ./jenkins-cert.yaml
        helm install jenkins jenkins/jenkins -n jenkins -f ./jenkins/jenkins-values.yaml
    '


########################################
# 5. Install MinIO
########################################
run "[12/12] Installing MinIO S3 services" \
    bash -c '
        kubectl create ns minio 2>/dev/null || true
        kubectl apply -f ./minios3/minio-cert.yaml
        helm install minio -n minio minio/minio -f ./minios3/minio-values.yaml
    '

echo ""
echo "✔ Core services installed."
echo ""
